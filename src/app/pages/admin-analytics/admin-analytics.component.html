<div class="analytics-container">
  <!-- Header -->
  <div class="analytics-header">
    <div class="header-content">
      <h1 class="analytics-title">گزارشات و آمار</h1>
      <p class="analytics-subtitle">تحلیل جامع عملکرد فروشگاه</p>
    </div>
    
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="refreshData()" [disabled]="loading()">
        <mat-icon>refresh</mat-icon>
        بروزرسانی
      </button>
      
      <button mat-raised-button color="accent" [matMenuTriggerFor]="exportMenu">
        <mat-icon>download</mat-icon>
        خروجی
      </button>
      
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportReport('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          <span>PDF</span>
        </button>
        <button mat-menu-item (click)="exportReport('excel')">
          <mat-icon>table_chart</mat-icon>
          <span>Excel</span>
        </button>
        <button mat-menu-item (click)="exportReport('csv')">
          <mat-icon>description</mat-icon>
          <span>CSV</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Filters -->
  <mat-card class="filters-card">
    <mat-card-content>
      <form [formGroup]="filterForm" class="filters-form">
        <div class="filter-row">
          <mat-form-field appearance="outline">
            <mat-label>بازه زمانی</mat-label>
            <mat-select formControlName="timeRange" (selectionChange)="onTimeRangeChange()">
              @for (option of timeRangeOptions; track option.value) {
                <mat-option [value]="option.value">{{ option.label }}</mat-option>
              }
            </mat-select>
            <mat-icon matSuffix>schedule</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>دسته‌بندی</mat-label>
            <mat-select formControlName="categories" multiple>
              <mat-option value="educational">اسباب بازی آموزشی</mat-option>
              <mat-option value="creative">اسباب بازی خلاقانه</mat-option>
              <mat-option value="physical">اسباب بازی حرکتی</mat-option>
              <mat-option value="electronic">اسباب بازی الکترونیکی</mat-option>
            </mat-select>
            <mat-icon matSuffix>category</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>منطقه</mat-label>
            <mat-select formControlName="regions" multiple>
              <mat-option value="tehran">تهران</mat-option>
              <mat-option value="isfahan">اصفهان</mat-option>
              <mat-option value="shiraz">شیراز</mat-option>
              <mat-option value="tabriz">تبریز</mat-option>
              <mat-option value="mashhad">مشهد</mat-option>
            </mat-select>
            <mat-icon matSuffix>location_on</mat-icon>
          </mat-form-field>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>در حال بارگذاری گزارشات...</p>
    </div>
  }

  <!-- Error State -->
  @else if (error()) {
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon class="error-icon">error</mat-icon>
          <h3>خطا در بارگذاری گزارشات</h3>
          <p>{{ error() }}</p>
          <button mat-raised-button color="primary" (click)="refreshData()">
            تلاش مجدد
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Analytics Content -->
  @else if (hasData()) {
    <div class="analytics-content">
      <!-- Overview Cards -->
      @if (selectedTab() === 0) {
        <div class="overview-section">
          <div class="stats-grid">
            <mat-card class="stat-card revenue-card">
              <mat-card-content>
                <div class="stat-content">
                  <div class="stat-icon">
                    <mat-icon>attach_money</mat-icon>
                  </div>
                  <div class="stat-info">
                    <h3 class="stat-number">{{ formatCurrency(summary()!.overview.totalRevenue) }}</h3>
                    <p class="stat-label">کل درآمد</p>
                    <div class="stat-growth">
                      <mat-icon [class]="getGrowthColor(summary()!.overview.monthlyGrowth)">
                        {{ getGrowthIcon(summary()!.overview.monthlyGrowth) }}
                      </mat-icon>
                      <span [class]="getGrowthColor(summary()!.overview.monthlyGrowth)">
                        {{ formatPercentage(summary()!.overview.monthlyGrowth) }}
                      </span>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="stat-card orders-card">
              <mat-card-content>
                <div class="stat-content">
                  <div class="stat-icon">
                    <mat-icon>shopping_cart</mat-icon>
                  </div>
                  <div class="stat-info">
                    <h3 class="stat-number">{{ formatNumber(summary()!.overview.totalOrders) }}</h3>
                    <p class="stat-label">کل سفارشات</p>
                    <div class="stat-growth">
                      <mat-icon class="text-blue-600">trending_up</mat-icon>
                      <span class="text-blue-600">+12.5%</span>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="stat-card customers-card">
              <mat-card-content>
                <div class="stat-content">
                  <div class="stat-icon">
                    <mat-icon>people</mat-icon>
                  </div>
                  <div class="stat-info">
                    <h3 class="stat-number">{{ formatNumber(summary()!.overview.totalUsers) }}</h3>
                    <p class="stat-label">کل مشتریان</p>
                    <div class="stat-growth">
                      <mat-icon class="text-green-600">trending_up</mat-icon>
                      <span class="text-green-600">+8.3%</span>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="stat-card products-card">
              <mat-card-content>
                <div class="stat-content">
                  <div class="stat-icon">
                    <mat-icon>inventory_2</mat-icon>
                  </div>
                  <div class="stat-info">
                    <h3 class="stat-number">{{ formatNumber(summary()!.overview.totalProducts) }}</h3>
                    <p class="stat-label">کل محصولات</p>
                    <div class="stat-growth">
                      <mat-icon class="text-blue-600">trending_up</mat-icon>
                      <span class="text-blue-600">+5.2%</span>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="secondary-stats">
            <mat-card class="secondary-stat-card">
              <mat-card-content>
                <h4>میانگین ارزش سفارش</h4>
                <p class="stat-value">{{ formatCurrency(summary()!.overview.averageOrderValue) }}</p>
              </mat-card-content>
            </mat-card>

            <mat-card class="secondary-stat-card">
              <mat-card-content>
                <h4>نرخ تبدیل</h4>
                <p class="stat-value">{{ formatPercentage(summary()!.overview.conversionRate) }}</p>
              </mat-card-content>
            </mat-card>

            <mat-card class="secondary-stat-card">
              <mat-card-content>
                <h4>رشد سالانه</h4>
                <p class="stat-value">{{ formatPercentage(summary()!.overview.yearOverYearGrowth) }}</p>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      }

      <!-- Revenue Tab -->
      @if (selectedTab() === 1) {
        <div class="revenue-section">
          <div class="revenue-overview">
            <mat-card class="revenue-card">
              <mat-card-header>
                <mat-card-title>درآمد کلی</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="revenue-stats">
                  <div class="revenue-stat">
                    <h3>{{ formatCurrency(summary()!.revenue.totalRevenue) }}</h3>
                    <p>کل درآمد</p>
                  </div>
                  <div class="revenue-stat">
                    <h3>{{ formatCurrency(summary()!.revenue.monthlyRevenue) }}</h3>
                    <p>درآمد ماهانه</p>
                  </div>
                  <div class="revenue-stat">
                    <h3>{{ formatCurrency(summary()!.revenue.dailyRevenue) }}</h3>
                    <p>درآمد روزانه</p>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="revenue-details">
            <mat-card class="revenue-sources-card">
              <mat-card-header>
                <mat-card-title>منابع درآمد</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="revenue-sources">
                  @for (source of summary()!.revenue.topRevenueSources; track source.source) {
                    <div class="revenue-source-item">
                      <div class="source-info">
                        <h4>{{ source.source }}</h4>
                        <p>{{ formatCurrency(source.revenue) }}</p>
                      </div>
                      <div class="source-stats">
                        <span class="percentage">{{ formatPercentage(source.percentage) }}</span>
                        <span class="orders">{{ source.orders }} سفارش</span>
                      </div>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      }

      <!-- Sales Tab -->
      @if (selectedTab() === 2) {
        <div class="sales-section">
          <div class="sales-overview">
            <mat-card class="sales-card">
              <mat-card-header>
                <mat-card-title>فروش کلی</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="sales-stats">
                  <div class="sales-stat">
                    <h3>{{ formatCurrency(summary()!.sales.totalSales) }}</h3>
                    <p>کل فروش</p>
                  </div>
                  <div class="sales-stat">
                    <h3>{{ formatNumber(summary()!.sales.totalUnits) }}</h3>
                    <p>تعداد واحد</p>
                  </div>
                  <div class="sales-stat">
                    <h3>{{ formatCurrency(summary()!.sales.averageOrderValue) }}</h3>
                    <p>میانگین سفارش</p>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="top-products">
            <mat-card class="top-products-card">
              <mat-card-header>
                <mat-card-title>محصولات پرفروش</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="products-list">
                  @for (product of summary()!.sales.topSellingProducts; track product.productId) {
                    <div class="product-item">
                      <img [src]="product.image" [alt]="product.productName" class="product-image">
                      <div class="product-info">
                        <h4>{{ product.productName }}</h4>
                        <p>{{ product.category }}</p>
                      </div>
                      <div class="product-stats">
                        <span class="units">{{ formatNumber(product.unitsSold) }} واحد</span>
                        <span class="revenue">{{ formatCurrency(product.revenue) }}</span>
                        <span class="growth" [class]="getGrowthColor(product.growth)">
                          {{ formatPercentage(product.growth) }}
                        </span>
                      </div>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      }

      <!-- Customers Tab -->
      @if (selectedTab() === 3) {
        <div class="customers-section">
          <div class="customers-overview">
            <mat-card class="customers-card">
              <mat-card-header>
                <mat-card-title>مشتریان</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="customers-stats">
                  <div class="customer-stat">
                    <h3>{{ formatNumber(summary()!.customers.totalCustomers) }}</h3>
                    <p>کل مشتریان</p>
                  </div>
                  <div class="customer-stat">
                    <h3>{{ formatNumber(summary()!.customers.newCustomers) }}</h3>
                    <p>مشتریان جدید</p>
                  </div>
                  <div class="customer-stat">
                    <h3>{{ formatNumber(summary()!.customers.activeCustomers) }}</h3>
                    <p>مشتریان فعال</p>
                  </div>
                  <div class="customer-stat">
                    <h3>{{ formatPercentage(summary()!.customers.customerRetentionRate) }}</h3>
                    <p>نرخ نگهداری</p>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="customer-segments">
            <mat-card class="segments-card">
              <mat-card-header>
                <mat-card-title>بخش‌بندی مشتریان</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="segments-list">
                  @for (segment of summary()!.customers.customerSegments; track segment.segment) {
                    <div class="segment-item">
                      <div class="segment-info">
                        <h4>{{ segment.segment }}</h4>
                        <p>{{ formatNumber(segment.count) }} مشتری</p>
                      </div>
                      <div class="segment-stats">
                        <span class="percentage">{{ formatPercentage(segment.percentage) }}</span>
                        <span class="average-value">{{ formatCurrency(segment.averageValue) }}</span>
                      </div>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      }

      <!-- Products Tab -->
      @if (selectedTab() === 4) {
        <div class="products-section">
          <div class="products-overview">
            <mat-card class="products-card">
              <mat-card-header>
                <mat-card-title>محصولات</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="products-stats">
                  <div class="product-stat">
                    <h3>{{ formatNumber(summary()!.products.totalProducts) }}</h3>
                    <p>کل محصولات</p>
                  </div>
                  <div class="product-stat">
                    <h3>{{ formatNumber(summary()!.products.activeProducts) }}</h3>
                    <p>محصولات فعال</p>
                  </div>
                  <div class="product-stat">
                    <h3>{{ formatNumber(summary()!.products.lowStockProducts) }}</h3>
                    <p>موجودی کم</p>
                  </div>
                  <div class="product-stat">
                    <h3>{{ formatCurrency(summary()!.products.inventoryValue) }}</h3>
                    <p>ارزش موجودی</p>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="products-by-category">
            <mat-card class="category-products-card">
              <mat-card-header>
                <mat-card-title>محصولات بر اساس دسته‌بندی</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="category-products-list">
                  @for (category of summary()!.products.productsByCategory; track category.categoryId) {
                    <div class="category-product-item">
                      <div class="category-info">
                        <h4>{{ category.categoryName }}</h4>
                        <p>{{ formatNumber(category.productCount) }} محصول</p>
                      </div>
                      <div class="category-stats">
                        <span class="total-value">{{ formatCurrency(category.totalValue) }}</span>
                        <span class="average-price">{{ formatCurrency(category.averagePrice) }}</span>
                      </div>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      }

      <!-- Orders Tab -->
      @if (selectedTab() === 5) {
        <div class="orders-section">
          <div class="orders-overview">
            <mat-card class="orders-card">
              <mat-card-header>
                <mat-card-title>سفارشات</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="orders-stats">
                  <div class="order-stat">
                    <h3>{{ formatNumber(summary()!.orders.totalOrders) }}</h3>
                    <p>کل سفارشات</p>
                  </div>
                  <div class="order-stat">
                    <h3>{{ formatNumber(summary()!.orders.completedOrders) }}</h3>
                    <p>تکمیل شده</p>
                  </div>
                  <div class="order-stat">
                    <h3>{{ formatNumber(summary()!.orders.pendingOrders) }}</h3>
                    <p>در انتظار</p>
                  </div>
                  <div class="order-stat">
                    <h3>{{ formatCurrency(summary()!.orders.averageOrderValue) }}</h3>
                    <p>میانگین سفارش</p>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="orders-by-status">
            <mat-card class="status-orders-card">
              <mat-card-header>
                <mat-card-title>سفارشات بر اساس وضعیت</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="status-orders-list">
                  @for (status of summary()!.orders.ordersByStatus; track status.status) {
                    <div class="status-order-item">
                      <div class="status-info">
                        <h4>{{ status.status }}</h4>
                        <p>{{ formatNumber(status.count) }} سفارش</p>
                      </div>
                      <div class="status-stats">
                        <span class="percentage">{{ formatPercentage(status.percentage) }}</span>
                        <span class="total-value">{{ formatCurrency(status.totalValue) }}</span>
                      </div>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      }

      <!-- Geographic Tab -->
      @if (selectedTab() === 6) {
        <div class="geographic-section">
          <div class="geographic-overview">
            <mat-card class="geographic-card">
              <mat-card-header>
                <mat-card-title>تحلیل جغرافیایی</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="geographic-stats">
                  <div class="geographic-stat">
                    <h3>{{ formatNumber(summary()!.geographic.topRegions.length) }}</h3>
                    <p>مناطق فعال</p>
                  </div>
                  <div class="geographic-stat">
                    <h3>{{ formatCurrency(summary()!.geographic.salesByRegion[0].sales) }}</h3>
                    <p>بهترین منطقه</p>
                  </div>
                  <div class="geographic-stat">
                    <h3>{{ formatPercentage(summary()!.geographic.salesByRegion[0].percentage) }}</h3>
                    <p>سهم برتر</p>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="top-regions">
            <mat-card class="regions-card">
              <mat-card-header>
                <mat-card-title>مناطق برتر</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="regions-list">
                  @for (region of summary()!.geographic.topRegions; track region.region) {
                    <div class="region-item">
                      <div class="region-info">
                        <h4>{{ region.region }}</h4>
                        <p>{{ formatNumber(region.customers) }} مشتری</p>
                      </div>
                      <div class="region-stats">
                        <span class="sales">{{ formatCurrency(region.sales) }}</span>
                        <span class="orders">{{ formatNumber(region.orders) }} سفارش</span>
                        <span class="growth" [class]="getGrowthColor(region.growth)">
                          {{ formatPercentage(region.growth) }}
                        </span>
                      </div>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      }
    </div>
  }

  <!-- Tabs Navigation -->
  <div class="tabs-container">
    <mat-tab-group [selectedIndex]="selectedTab()" (selectedIndexChange)="onTabChange($event)">
      @for (label of tabLabels; track label; let i = $index) {
        <mat-tab [label]="label"></mat-tab>
      }
    </mat-tab-group>
  </div>
</div> 