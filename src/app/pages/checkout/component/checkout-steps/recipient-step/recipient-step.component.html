<!-- Logged-in User: Address Selection -->
@if (userMode() === 'logged-in') {
  <div class="space-y-6">
    <!-- User Info Card -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
      <div class="flex items-center">
        <mat-icon class="text-green-500 mr-2">person</mat-icon>
        <div>
          <div class="font-semibold text-green-900">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</div>
          <div class="text-green-700 text-sm">{{ authService.currentUser()?.firstName }} {{ authService.currentUser()?.lastName }}</div>
        </div>
      </div>
    </div>

    <!-- Address Selection -->
    <form [formGroup]="addressSelectionForm" class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900">Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø¯Ø±Ø³</h3>
      
      <div class="space-y-3">
        @for (address of savedAddresses; track address.id) {
          <div class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors"
               [class.bg-blue-50]="addressSelectionForm.get('selectedAddress')?.value === address.id"
               [class.border-blue-300]="addressSelectionForm.get('selectedAddress')?.value === address.id"
               (click)="onAddressSelect(address.id)">
            <div class="flex items-start justify-between">
              <div class="flex items-center space-x-3 space-x-reverse">
                <mat-radio-button [value]="address.id" formControlName="selectedAddress"></mat-radio-button>
                <div>
                  <div class="font-medium">{{ address.title }}</div>
                  <div class="text-sm text-gray-600">{{ address.address }}</div>
                  <div class="text-sm text-gray-500">{{ address.city }}ØŒ {{ address.state }}</div>
                  @if (address.zipCode) {
                    <div class="text-sm text-gray-500">Ú©Ø¯ Ù¾Ø³ØªÛŒ: {{ address.zipCode }}</div>
                  }
                </div>
              </div>
              @if (address.isDefault) {
                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Ù¾ÛŒØ´â€ŒÙØ±Ø¶</span>
              }
            </div>
          </div>
        }
      </div>

      @if (isFieldInvalid(addressSelectionForm, 'selectedAddress')) {
        <div class="text-red-600 text-sm">Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¢Ø¯Ø±Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
      }
    </form>

    <!-- Gift Option -->
    <div class="flex items-center space-x-2 space-x-reverse">
      <mat-checkbox [checked]="isGift()" (change)="onGiftToggle()">
        Ø§ÛŒÙ† Ø³ÙØ§Ø±Ø´ Ù‡Ø¯ÛŒÙ‡ Ø§Ø³Øª ğŸ
      </mat-checkbox>
    </div>

    <!-- Gift Form -->
    @if (showGiftForm()) {
      <div class="mt-6 p-4 bg-pink-50 border border-pink-200 rounded-lg">
        <h4 class="text-lg font-semibold text-pink-900 mb-4 flex items-center">
          <span class="text-2xl mr-2">ğŸ</span>
          Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ù‡Ø¯ÛŒÙ‡
        </h4>
        
        <form [formGroup]="giftForm" class="space-y-4">
          <!-- Gift Province and City -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Ø§Ø³ØªØ§Ù† Ú¯ÛŒØ±Ù†Ø¯Ù‡</mat-label>
              <mat-select formControlName="giftState" (selectionChange)="onGiftProvinceChange($event.value)">
                @for (province of provinces; track province.id) {
                  <mat-option [value]="province.id">{{ province.name }}</mat-option>
                }
              </mat-select>
              @if (isFieldInvalid(giftForm, 'giftState')) {
                <mat-error>{{ getFieldError(giftForm, 'giftState') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Ø´Ù‡Ø± Ú¯ÛŒØ±Ù†Ø¯Ù‡</mat-label>
              <mat-select formControlName="giftCity" [disabled]="!selectedGiftProvince()">
                @for (city of availableGiftCities(); track city) {
                  <mat-option [value]="city">{{ city }}</mat-option>
                }
              </mat-select>
              @if (isFieldInvalid(giftForm, 'giftCity')) {
                <mat-error>{{ getFieldError(giftForm, 'giftCity') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Gift Address -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Ø¢Ø¯Ø±Ø³ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ù‡Ø¯ÛŒÙ‡</mat-label>
            <textarea matInput formControlName="giftAddress" rows="3" 
              placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ù‡Ø¯ÛŒÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"></textarea>
            @if (isFieldInvalid(giftForm, 'giftAddress')) {
              <mat-error>{{ getFieldError(giftForm, 'giftAddress') }}</mat-error>
            }
          </mat-form-field>

          <!-- Gift Zip Code -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Ú©Ø¯ Ù¾Ø³ØªÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</mat-label>
            <input matInput formControlName="giftZipCode" placeholder="1234567890" type="text" maxlength="10">
            @if (isFieldInvalid(giftForm, 'giftZipCode')) {
              <mat-error>{{ getFieldError(giftForm, 'giftZipCode') }}</mat-error>
            }
          </mat-form-field>

          <!-- Gift Message -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Ù¾ÛŒØ§Ù… Ù‡Ø¯ÛŒÙ‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</mat-label>
            <textarea matInput formControlName="giftMessage" rows="2" 
              placeholder="Ù¾ÛŒØ§Ù… ØªØ¨Ø±ÛŒÚ© Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
            <mat-hint>Ø­Ø¯Ø§Ú©Ø«Ø± Û²Û°Û° Ú©Ø§Ø±Ø§Ú©ØªØ±</mat-hint>
            @if (isFieldInvalid(giftForm, 'giftMessage')) {
              <mat-error>{{ getFieldError(giftForm, 'giftMessage') }}</mat-error>
            }
          </mat-form-field>
        </form>
      </div>
    }
  </div>
}

<!-- Login Form -->
@if (userMode() === 'login') {
  <form [formGroup]="loginForm" class="space-y-6">
    <div class="text-center mb-6">
      <h3 class="text-xl font-semibold text-gray-900">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
      <p class="text-gray-600 mt-2">Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯</p>
    </div>

    <!-- Email -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Ø§ÛŒÙ…ÛŒÙ„</mat-label>
      <input matInput formControlName="email" placeholder="example@email.com" type="email">
      @if (isFieldInvalid(loginForm, 'email')) {
        <mat-error>{{ getFieldError(loginForm, 'email') }}</mat-error>
      }
    </mat-form-field>

    <!-- Password -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</mat-label>
      <input matInput formControlName="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" type="password">
      @if (isFieldInvalid(loginForm, 'password')) {
        <mat-error>{{ getFieldError(loginForm, 'password') }}</mat-error>
      }
    </mat-form-field>

    <!-- Login Button -->
    <button mat-raised-button 
            color="primary" 
            (click)="onLoginSubmit()" 
            [disabled]="loginForm.invalid"
            class="w-full">
      ÙˆØ±ÙˆØ¯
    </button>

    <!-- Switch to Register -->
    <div class="text-center">
      <button mat-button (click)="onSwitchToRegister()" class="text-blue-600">
        Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯
      </button>
    </div>
  </form>
}

<!-- Register Form -->
@if (userMode() === 'register') {
  <!-- Switch to Login -->
  <div class="text-center">
    <button mat-button (click)="onSwitchToLogin()" class="text-blue-600">
      Ù‚Ø¨Ù„Ø§Ù‹ Ø¹Ø¶Ùˆ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯
    </button>
  </div>

  <form [formGroup]="recipientForm" class="space-y-6">
    
    <!-- Name Fields -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Ù†Ø§Ù…</mat-label>
        <input matInput formControlName="firstName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        @if (isFieldInvalid(recipientForm, 'firstName')) {
          <mat-error>{{ getFieldError(recipientForm, 'firstName') }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</mat-label>
        <input matInput formControlName="lastName" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        @if (isFieldInvalid(recipientForm, 'lastName')) {
          <mat-error>{{ getFieldError(recipientForm, 'lastName') }}</mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Phone -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</mat-label>
      <input matInput formControlName="phone" placeholder="09123456789" type="tel">
      <mat-hint>Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯</mat-hint>
      @if (isFieldInvalid(recipientForm, 'phone')) {
        <mat-error>{{ getFieldError(recipientForm, 'phone') }}</mat-error>
      }
    </mat-form-field>

    <!-- Email (Optional) -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Ø§ÛŒÙ…ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</mat-label>
      <input matInput formControlName="email" placeholder="example@email.com" type="email">
      <mat-hint>Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ±ÙˆØ¯ØŒ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯</mat-hint>
      @if (isFieldInvalid(recipientForm, 'email')) {
        <mat-error>{{ getFieldError(recipientForm, 'email') }}</mat-error>
      }
    </mat-form-field>

    <!-- Province and City -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Ø§Ø³ØªØ§Ù†</mat-label>
        <mat-select formControlName="state" (selectionChange)="onProvinceChange($event.value)">
          @for (province of provinces; track province.id) {
            <mat-option [value]="province.id">{{ province.name }}</mat-option>
          }
        </mat-select>
        @if (isFieldInvalid(recipientForm, 'state')) {
          <mat-error>{{ getFieldError(recipientForm, 'state') }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Ø´Ù‡Ø±</mat-label>
        <mat-select formControlName="city" [disabled]="!selectedProvince()">
          @for (city of availableCities(); track city) {
            <mat-option [value]="city">{{ city }}</mat-option>
          }
        </mat-select>
        @if (isFieldInvalid(recipientForm, 'city')) {
          <mat-error>{{ getFieldError(recipientForm, 'city') }}</mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Address -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Ø¢Ø¯Ø±Ø³ Ø¯Ù‚ÛŒÙ‚</mat-label>
      <textarea matInput formControlName="address" rows="3" 
        placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: Ø®ÛŒØ§Ø¨Ø§Ù† ÙØ±Ø¯ÙˆØ³ÛŒØŒ Ú©ÙˆÚ†Ù‡ Û±ÛµØŒ Ù¾Ù„Ø§Ú© Û²Û³ØŒ Ø·Ø¨Ù‚Ù‡ Û³)"></textarea>
      <mat-hint>Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ ØªØ­ÙˆÛŒÙ„ Ø³ÙØ§Ø±Ø´</mat-hint>
      @if (isFieldInvalid(recipientForm, 'address')) {
        <mat-error>{{ getFieldError(recipientForm, 'address') }}</mat-error>
      }
    </mat-form-field>

    <!-- Zip Code -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Ú©Ø¯ Ù¾Ø³ØªÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</mat-label>
      <input matInput formControlName="zipCode" placeholder="1234567890" type="text" maxlength="10">
      <mat-hint>Ú©Ø¯ Ù¾Ø³ØªÛŒ Û±Û° Ø±Ù‚Ù…ÛŒ</mat-hint>
      @if (isFieldInvalid(recipientForm, 'zipCode')) {
        <mat-error>{{ getFieldError(recipientForm, 'zipCode') }}</mat-error>
      }
    </mat-form-field>

    <!-- Gift Option -->
    <div class="flex items-center space-x-2 space-x-reverse">
      <mat-checkbox [checked]="isGift()" (change)="onGiftToggle()">
        Ø§ÛŒÙ† Ø³ÙØ§Ø±Ø´ Ù‡Ø¯ÛŒÙ‡ Ø§Ø³Øª ğŸ
      </mat-checkbox>
    </div>

    <!-- Gift Form -->
    @if (showGiftForm()) {
      <div class="mt-6 p-4 bg-pink-50 border border-pink-200 rounded-lg">
        <h4 class="text-lg font-semibold text-pink-900 mb-4 flex items-center">
          <span class="text-2xl mr-2">ğŸ</span>
          Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ù‡Ø¯ÛŒÙ‡
        </h4>
        
        <form [formGroup]="giftForm" class="space-y-4">
          <!-- Gift Province and City -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Ø§Ø³ØªØ§Ù† Ú¯ÛŒØ±Ù†Ø¯Ù‡</mat-label>
              <mat-select formControlName="giftState" (selectionChange)="onGiftProvinceChange($event.value)">
                @for (province of provinces; track province.id) {
                  <mat-option [value]="province.id">{{ province.name }}</mat-option>
                }
              </mat-select>
              @if (isFieldInvalid(giftForm, 'giftState')) {
                <mat-error>{{ getFieldError(giftForm, 'giftState') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Ø´Ù‡Ø± Ú¯ÛŒØ±Ù†Ø¯Ù‡</mat-label>
              <mat-select formControlName="giftCity" [disabled]="!selectedGiftProvince()">
                @for (city of availableGiftCities(); track city) {
                  <mat-option [value]="city">{{ city }}</mat-option>
                }
              </mat-select>
              @if (isFieldInvalid(giftForm, 'giftCity')) {
                <mat-error>{{ getFieldError(giftForm, 'giftCity') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Gift Address -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Ø¢Ø¯Ø±Ø³ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ù‡Ø¯ÛŒÙ‡</mat-label>
            <textarea matInput formControlName="giftAddress" rows="3" 
              placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ù‡Ø¯ÛŒÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"></textarea>
            @if (isFieldInvalid(giftForm, 'giftAddress')) {
              <mat-error>{{ getFieldError(giftForm, 'giftAddress') }}</mat-error>
            }
          </mat-form-field>

          <!-- Gift Zip Code -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Ú©Ø¯ Ù¾Ø³ØªÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</mat-label>
            <input matInput formControlName="giftZipCode" placeholder="1234567890" type="text" maxlength="10">
            @if (isFieldInvalid(giftForm, 'giftZipCode')) {
              <mat-error>{{ getFieldError(giftForm, 'giftZipCode') }}</mat-error>
            }
          </mat-form-field>

          <!-- Gift Message -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Ù¾ÛŒØ§Ù… Ù‡Ø¯ÛŒÙ‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</mat-label>
            <textarea matInput formControlName="giftMessage" rows="2" 
              placeholder="Ù¾ÛŒØ§Ù… ØªØ¨Ø±ÛŒÚ© Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
            <mat-hint>Ø­Ø¯Ø§Ú©Ø«Ø± Û²Û°Û° Ú©Ø§Ø±Ø§Ú©ØªØ±</mat-hint>
            @if (isFieldInvalid(giftForm, 'giftMessage')) {
              <mat-error>{{ getFieldError(giftForm, 'giftMessage') }}</mat-error>
            }
          </mat-form-field>
        </form>
      </div>
    }
  </form>
}
